name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'testing'
        type: choice
        options:
        - testing
        - prerelease
        - release

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        if (Test-Path "dist") { Remove-Item -Recurse -Force dist }
        if (Test-Path "build") { Remove-Item -Recurse -Force build }
        
        pyinstaller --noconfirm --onefile --windowed --name="DXF_MergeTool" --add-data="dxf_processor.py;." --add-data="dxf_renderer.py;." --hidden-import="PIL" --clean gui_app.py
        
    - name: Verify executable
      run: |
        $file = Get-Item "dist/DXF_MergeTool.exe"
        if ($file.Length -lt 1MB) {
          Write-Error "生成的可执行文件过小，可能构建失败"
          exit 1
        }
        Write-Host "✅ 可执行文件大小: $([math]::Round($file.Length/1MB, 2)) MB"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DXF_MergeTool-${{ github.sha }}
        path: dist/DXF_MergeTool.exe
        retention-days: 30
        
    - name: Create Testing Artifact
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'testing' }}
      run: |
        Write-Host "✅ 测试构建完成，可在 Artifacts 中下载"
        
    - name: Create Manual Release
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type != 'testing' }}
      uses: ncipollo/release-action@v1
      with:
        artifacts: "dist/DXF_MergeTool.exe"
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: ${{ github.event.inputs.build_type == 'prerelease' }}
        prerelease: ${{ github.event.inputs.build_type == 'prerelease' }}
        name: Manual Build ${{ github.run_number }}
        tag: manual-${{ github.run_number }}
        body: |
          手动构建版本 #${{ github.run_number }}
          - 提交: ${{ github.sha }}
          - 构建类型: ${{ github.event.inputs.build_type }}
          - 触发者: ${{ github.actor }}
          
    - name: Create Tag Release
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
      uses: ncipollo/release-action@v1
      with:
        artifacts: "dist/DXF_MergeTool.exe"
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        generateReleaseNotes: true